import t from"fs-extra";import e from"get-value";import o from"object.defaults/mutable.js";import r from"ora";import a from"chalk";import n from"log-symbols";import i from"path";import s from"sane";import{debounce as c}from"throttle-debounce";import{globby as l}from"globby";import p from"set-value";import{promisify as u}from"util";import{exec as f}from"child_process";import d from"camelcase";import{findUp as m}from"find-up";import g from"pupa";import h from"uppercamelcase";import y from"object.pick";function w(t){return t.replace(/([\da-z])([A-Z])/g,"$1-$2").replace(/([A-Z])([A-Z])(?=[a-z])/g,"$1-$2").toLowerCase()}function $(t,e){const o=/@([\d.]+)x/.exec(t);return o?Number.parseFloat(o[1]):void 0!==e?e:1}function x(t){let o=e(t,"meta.number_of_packs",{default:0});return 0===o&&(o=e(t,"meta.related_multi_packs",{default:[]}).length+1),o}const j=u(f),b={format:"pixijs4","texture-format":"png","jpg-quality":100,"max-size":2048,"png-opt-level":0,opt:"RGBA8888","prepend-folder-name":!0,"trim-sprite-names":!0,algorithm:"MaxRects","maxrects-heuristics":"Best","pack-mode":"Best","scale-mode":"Smooth",multipack:!0,"force-identical-layout":!0,"trim-mode":"Trim","alpha-handling":"ClearTransparentPixels","default-pivot-point":"0,0","enable-rotation":!0,quiet:!0,extrude:"0","shape-padding":"2",variant:["1:@2x","0.5:"]};async function k(t,e){const r=function(t,e){"1"===(e=e||{}).extrude&&(e["shape-padding"]=0);"jpg"===e["texture-format"]&&(e["alpha-handling"]="ReduceBorderArtifacts");const o=new v;o.addPath(`${t}`);for(const t of Object.keys(e))o.addOption(t,e[t]);return o.build()}(t,o(e,b));try{await j(r)}catch(t){if(t&&t.stderr)throw new Error(t.stderr);return!1}return!0}class v{constructor(){this.commands=[],this.path=""}addPath(t){this.path=t}addOption(t,e){this.commands.push({option:`--${w(t)}`,value:e})}build(){if(!this.path)throw new Error("Must specify a path to process (image/directory)");const t=this.commands.map((t=>this.resolveValue(t.option,t.value))).join(" ");return`TexturePacker ${this.path} ${t}`}resolveValue(t,e){return Array.isArray(e)?e.map((e=>this.resolveValue(t,e))).join(" "):`${t}${e=!0===e?"":` ${e}`}`}}function D(t,e){let o=(t=`${t}`).replace(`${e}/`,"").split("/").map((t=>function(t){return t.replace(/(\W)/g,"_").replace(/_{2,}/g,".").replace(/^_/,"").replace(/_$/,"")}(t))),r=o.pop();r=r.toUpperCase(),o=o.map((t=>d(t)));let a=e.split("/");return a=a.slice(a.length-(1===a.length?1:2)),a.push("sprites"),a=h(a.join("-")),o.length>0?[a,t=(t=o.join(".")).replace(/(\W^\.)/g,"").replace(/\.{2,}/g,".").replace(/^\./,"").replace(/\.$/,""),r].join("."):[a,r].join(".")}function P(t){if(t.length>0){const o=t[0];return e(o,"meta.number_of_packs",{default:1})}return 0}async function N(o,r,s,c){const l=await async function(o,r,a,n){const s=e(n,"includeSizeInfo",a.includeSizeInfo),c=e(n,"includePNGExpressMetadata",a.includePNGExpressMetadata),l=e(n,"originalResolution",a.originalResolution),p={};if(!s&&!c)return p;for(const t of o||[])for(const e of Object.keys(t.frames)){const o=t.frames[e];p[e]={id:e,width:o.sourceSize.w,height:o.sourceSize.h}}if(c)try{const e=i.join(a.sourceDirectory,r),o=await m("pngexpress-metadata.json",{cwd:e,type:"file"});if(o){const a=`${i.relative(o,e).replace(`..${i.sep}`,"")}/`,n=await t.readJson(o);for(const t of n.assets)for(const e of t.states){let o=r+t.id.replace(a,"");o="/"===o[0]?o.slice(1):o,o="default"===e?o:o+e;const n=y(t,["x","y","zIndex","visible","opacity"]);n.x=n.x/l,n.y=n.y/l,n.opacity=n.opacity/100,p[o]={...n,...p[o]}}return p}}catch(t){console.log(t)}return p}(o,r,s,c),u=e(c,"includeSizeInfo",s.includeSizeInfo),f=e(c,"includePNGExpressMetadata",s.includePNGExpressMetadata),d=r,g={};for(const t of o||[])for(const e of Object.keys(t.frames)){let t=e;(u||f)&&(l[e]?t={id:e,...l[e]}:console.log("\n",n.warning,a.yellow(`Could not find asset info for ${e}, check the export filename.`),"\n")),p(g,D(e,d),t)}return g}function O(t,e){let o="";const r=Object.keys(t)[0]??"Unknown",a=function(t){const e=[];for(const o of Object.keys(t))Object.prototype.hasOwnProperty.call(t,o)&&e.push([o,t[o]]);e.sort(((t,e)=>{const o=t[0],r=e[0];return o<r?-1:o>r?1:0}));const o={};for(const t of e)o[t[0]]=t[1];return o}(t[r]??{});let n=JSON.stringify(a,void 0,2);return n=n.replace(/"([^"()]+)":/g,"$1:"),o=`${o}${g("export const {assetName} = {assetData};",{assetName:r,assetData:n})}\n`,o=`${o}${g("export const {assetsVariable}LoaderInfo = {\n  assets: {assetsVariable},\n  fileName : '{fileName}',\n  numberOfParts : {numberOfParts},\n  type: 'sprites'\n};",{assetsVariable:r,fileName:e.fileName,numberOfParts:e.numberOfParts})}\n`,o}function _(t,e){const o=t.split("/"),r=o.pop();return o.length<2&&o.push(r),t=o.join("/"),`${i.join(e,t)}/assets/sprites-${r}.ts`}const z={},S={};async function A(o,s){let c,u;const f=async function(t,e,o){z[o]=!1,S[o]?(S[o]=!1,w.warn("Needs repacking, something changed while packing..."),await A(t,e)):w.succeed(`Done packing ${o}`)};Array.isArray(o)?(c=o[0],u=o[1]):c=o;const d=c.split("/").pop(),m=`${i.join(s.targetDirectory,c)}`;if(z[c])return console.log(n.warning,a.yellow("Already packing, starting again afterwards...")),void(S[c]=!0);z[c]=!0;const g=e(u,"textureFormat",s.textureFormat),h=e(u,"onlyGenerateCode",s.onlyGenerateCode),y={sheet:`${i.join(s.targetDirectory,c,d)}-{n1}{v}.${g}`,data:`${i.join(s.targetDirectory,c,d)}-{n1}{v}.json`,replace:`^${d}=${c}`,extrude:e(u,"extrude",s.extrude)?"1":"0","texture-format":g,"max-size":e(u,"maxSize",s.maxSize)},w=r(`Packing ${c}`).start();if(!0===h){if(!0===await async function(o,r,a){const n=_(o,e(a,"scriptDirectory",r.scriptDirectory));return await t.pathExists(n)}(c,s))return void await f(o,s,c)}try{if(!await k(`${i.join(s.sourceDirectory,c)}`,y))return void w.fail(`Error packing ${c}`)}catch(t){return w.fail(`Error packing ${c}`),void console.error(n.warning,t.message)}await async function(e){const o=await l(`${i.posix.join(e,"/")}*.json`);for(const e of o){const o=$(e),r=await t.readJson(e);p(r,"meta.scale",o),p(r,"meta.number_of_packs",x(r)),p(r,"meta.related_multi_packs"),await t.writeJson(e,r)}}(`${i.posix.join(s.targetDirectory,c)}`),await async function(o,r,a){const n=e(a,"scriptDirectory",r.scriptDirectory),s=await l(`${i.posix.join(r.targetDirectory,o,"/")}*[0-9]+.json`),c=[];for(const e of s)c.push(t.readJson(e));const p=await Promise.all(c);if(0===p.length)return void console.error(`No texture info found for path ${o}`);const u=O(await N(p,o,r,a),{fileName:o,numberOfParts:P(p)}),f=_(o,n);await t.outputFile(f,u)}(c,s,u),!0===h&&await async function(e){const o=await l(`${e}/*.{json,jpeg,jpg,png}`);return Promise.all(o.map((e=>t.unlink(e))))}(m),await f(o,s,c)}async function E(t,e){return new Promise((o=>{let r,l={};if(Array.isArray(t)?(r=t[0],l=t[1]):r=t,!0!==e.watch&&!0!==l.watch||!1===l.watch)return void o();const p=c(e.watchDelay,(()=>{A(t,e)})),u=s(`${i.join(e.sourceDirectory,r)}`,{glob:["**/*.png","**/*.jpg"]});u.on("ready",(()=>{console.log(n.info,a.blue(`Started watching ${r} with a delay of ${e.watchDelay/1e3}s`)),o()})),u.on("change",p),u.on("add",p),u.on("delete",p)}))}async function G(i){const s=await async function(a){const n=r(`Reading settings from ${a}...`).start();let i={};try{const r=await t.readJSON(a);i=e(r,"sprites",{}),i=o(i,{sourceDirectory:"./assets/",scriptDirectory:"./assets/converted/",targetDirectory:"./assets/converted/",watch:!1,watchDelay:500,extrude:!1,originalResolution:2,textureFormat:"png",includeSizeInfo:!1,includePNGExpressMetadata:!1,directories:[]})}catch{return n.fail(`Could not load settings from ${a}... (does it exist?)`),i}const s=i.directories.length;return s?n.succeed(`Found ${s} directories to process...`):n.fail("Found no directories to process..."),i}(i),c=s.directories;delete s.directories,s&&c&&(await async function(t,e){console.log(n.info,a.blue("Start packing all items..."));for(const o of t)await A(o,e);console.log(n.success,a.green("Done packing all items..."))}(c,s),await async function(t,e){for(const o of t)await E(o,e)}(c,s))}function C(t){G(t||"assets.json")}export{C as pack};
