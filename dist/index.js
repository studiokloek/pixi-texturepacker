"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("ora"),t=require("fs-extra"),r=require("get-value"),a=require("object.defaults");const o=require("fs-extra"),n=require("set-value"),i=require("globby");function s(e){return e.replace(/([\da-z])([A-Z])/g,"$1-$2").replace(/([A-Z])([A-Z])(?=[a-z])/g,"$1-$2").toLowerCase()}async function c(e){const t=await i(`${e}/*.json`);return Promise.all(t.map((async e=>{const t=function(e,t){const r=/@([\d.]+)x/.exec(e);return r?Number.parseFloat(r[1]):void 0!==t?t:1}(e),r=await o.readJson(e);return n(r,"meta.scale",t),o.writeJson(e,r)})))}const u=require("object.defaults"),l=require("util").promisify(require("child_process").exec),p={format:"pixijs4","texture-format":"png","jpg-quality":100,"max-size":2048,"png-opt-level":0,opt:"RGBA8888","prepend-folder-name":!0,"trim-sprite-names":!0,algorithm:"MaxRects","maxrects-heuristics":"Best","pack-mode":"Best","scale-mode":"Smooth",multipack:!0,"force-identical-layout":!0,"trim-mode":"Trim","alpha-handling":"ClearTransparentPixels","default-pivot-point":"0,0","enable-rotation":!0,quiet:!0,extrude:"0","shape-padding":"2",variant:["1:@2x","0.5:"]};async function d(e,t){const r=function(e,t){"1"===(t=t||{}).extrude&&(t["shape-padding"]=0);"jpg"===t["texture-format"]&&(t["alpha-handling"]="ReduceBorderArtifacts");const r=new f;return r.addPath(`${e}`),Object.keys(t).forEach((e=>{r.addOption(e,t[e])})),r.build()}(e,u(t,p));try{await l(r)}catch(e){if(e&&e.stderr)throw new Error(e.stderr);return!1}return!0}class f{constructor(){this.commands=[],this.path=""}addPath(e){this.path=e}addOption(e,t){this.commands.push({option:`--${s(e)}`,value:t})}build(){if(!this.path)throw new Error("Must specify a path to process (image/directory)");const e=this.commands.map((e=>this.resolveValue(e.option,e.value))).join(" ");return`TexturePacker ${this.path} ${e}`}resolveValue(e,t){return Array.isArray(t)?t.map((t=>this.resolveValue(e,t))).join(" "):`${e}${t=!0===t?"":` ${t}`}`}}const y=require("find-up"),g=require("fs-extra"),h=require("get-value"),m=require("set-value"),w=require("globby"),$=require("pupa"),x=require("uppercamelcase"),j=require("camelcase"),b=require("path"),q=require("object.pick");function v(e,t){let r=(e=`${e}`).replace(`${t}/`,"").split("/").map((e=>function(e){return e.replace(/(\W)/g,"_").replace(/_{2,}/g,".").replace(/^_/,"").replace(/_$/,"")}(e))),a=r.pop();a=a.toUpperCase(),r=r.map((e=>j(e)));let o=t.split("/");return o=o.slice(o.length-(1===o.length?1:2)),o.push("sprites"),o=x(o.join("-")),r.length>0?[o,e=(e=r.join(".")).replace(/(\W^\.)/g,"").replace(/\.{2,}/g,".").replace(/^\./,"").replace(/\.$/,""),a].join("."):[o,a].join(".")}function k(e){if(e.length>0){const t=e[0];return h(t,"meta.related_multi_packs",{default:[]}).length+1}return 0}async function D(e,t,r,a){const o=await async function(e,t,r,a){const o=h(a,"includeSizeInfo",r.includeSizeInfo),n=h(a,"includePNGExpressMetadata",r.includePNGExpressMetadata),i={};if(!o&&!n)return i;for(const t of e||[])for(const e of Object.keys(t.frames)){const r=t.frames[e];i[e]={id:e,width:r.sourceSize.w,height:r.sourceSize.h}}if(n)try{const e=await y("pngexpress-metadata.json",{cwd:b.join(r.sourceDirectory,t),type:"file"});if(e){const a=`${b.relative(e,b.join(r.sourceDirectory,t)).replace("../","")}/`,o=await g.readJson(e);for(const e of o.assets)for(const r of e.states){let o=t+e.id.replace(a,"");o="/"===o[0]?o.slice(1):o,o="default"===r?o:o+r;const n=q(e,["x","y","zIndex","visible","opacity"]);n.opacity=n.opacity/100,i[o]={...n,...i[o]}}return i}}catch(e){console.log(e)}return i}(e,t,r,a),n=t,i={};for(const t of e||[])for(const e of Object.keys(t.frames)){let t=e;o[e]&&(t={id:e,...o[e]}),m(i,v(e,n),t)}return i}function P(e,t){let r="";const a=Object.keys(e)[0],o=function(e){const t=[];for(const r of Object.keys(e))Object.prototype.hasOwnProperty.call(e,r)&&t.push([r,e[r]]);t.sort(((e,t)=>{const r=e[0],a=t[0];return r<a?-1:r>a?1:0}));const r={};for(const e of t)r[e[0]]=e[1];return r}(e[a]);let n=JSON.stringify(o,void 0,2);return n=n.replace(/"([^"()]+)":/g,"$1:"),r=`${r}${$("export const {assetName} = {assetData};",{assetName:a,assetData:n})}\n`,r=`${r}${$("export default {\n  assets: {assetsVariable},\n  fileName : '{fileName}',\n  numberOfParts : {numberOfParts},\n  type: 'sprites'\n};",{assetsVariable:a,fileName:t.fileName,numberOfParts:t.numberOfParts})}\n`,r}function O(e,t){const r=e.split("/"),a=r.pop();return r.length<2&&r.push(a),e=r.join("/"),`${b.join(t,e)}/assets/sprites-${a}.ts`}const N=require("ora"),z=require("log-symbols"),A=require("chalk"),S=require("path"),E=require("get-value"),_={},C={};async function F(e,t){let r,a;const n=async function(e,t,r){_[r]=!1,C[r]?(C[r]=!1,y.warn("Needs repacking, something changed while packing..."),await F(e,t)):y.succeed(`Done packing ${r}`)};Array.isArray(e)?(r=e[0],a=e[1]):r=e;const s=r.split("/").pop(),u=`${S.join(t.targetDirectory,r)}`;if(_[r])return console.log(z.warning,A.yellow("Already packing, starting again afterwards...")),void(C[r]=!0);_[r]=!0;const l=E(a,"textureFormat",t.textureFormat),p=E(a,"onlyGenerateCode",t.onlyGenerateCode),f={sheet:`${S.join(t.targetDirectory,r,s)}-{n1}{v}.${l}`,data:`${S.join(t.targetDirectory,r,s)}-{n1}{v}.json`,replace:`^${s}=${r}`,extrude:E(a,"extrude",t.extrude)?"1":"0","texture-format":l,"max-size":E(a,"maxSize",t.maxSize)},y=N(`Packing ${r}`).start();if(!0===p){if(!0===await async function(e,t,r){const a=O(e,h(r,"scriptDirectory",t.scriptDirectory));return await g.pathExists(a)}(r,t))return void await n(e,t,r)}try{if(!await d(`${S.join(t.sourceDirectory,r)}`,f))return void y.fail(`Error packing ${r}`)}catch(e){return y.fail(`Error packing ${r}`),void console.error(z.warning,e.message)}await c(u),await async function(e,t,r){const a=h(r,"scriptDirectory",t.scriptDirectory),o=await w(`${b.join(t.targetDirectory,e)}/*[0-9]+.json`),n=[];for(const e of o)n.push(g.readJson(e));const i=await Promise.all(n),s=P(await D(i,e,t,r),{fileName:e,numberOfParts:k(i)}),c=O(e,a);await g.outputFile(c,s)}(r,t,a),!0===p&&await async function(e){const t=await i(`${e}/*.{json,jpeg,jpg,png}`);return Promise.all(t.map((e=>o.unlink(e))))}(u),await n(e,t,r)}const G=require("sane"),J=require("log-symbols"),M=require("chalk"),{debounce:V}=require("throttle-debounce"),B=require("path");async function I(e,t){return new Promise((r=>{let a,o={};if(Array.isArray(e)?(a=e[0],o=e[1]):a=e,!0!==t.watch&&!0!==o.watch||!1===o.watch)return void r();const n=V(t.watchDelay,(()=>{F(e,t)})),i=G(`${B.join(t.sourceDirectory,a)}`,{glob:["**/*.png","**/*.jpg"]});i.on("ready",(()=>{console.log(J.info,M.blue(`Started watching ${a} with a delay of ${t.watchDelay/1e3}s`)),r()})),i.on("change",n),i.on("add",n),i.on("delete",n)}))}async function R(o){const n=await async function(o){const n=e(`Reading settings from ${o}...`).start();let i={};try{const e=await t.readJSON(o);i=r(e,"sprites",{}),i=a(i,{sourceDirectory:"./assets/",scriptDirectory:"./assets/converted/",targetDirectory:"./assets/converted/",watch:!1,watchDelay:500,extrude:!1,textureFormat:"png",onlyGenerateCode:!1,includeSizeInfo:!1,includePNGExpressMetadata:!1,directories:[]})}catch{return n.fail(`Could not load settings from ${o}... (does it exist?)`),i}const s=i.directories.length;return s?n.succeed(`Found ${s} directories to process...`):n.fail("Found no directories to process..."),i}(o),i=n.directories;delete n.directories,n&&i&&(await async function(e,t){console.log(z.info,A.blue("Start packing all items..."));for(const r of e)await F(r,t);console.log(z.success,A.green("Done packing all items..."))}(i,n),await async function(e,t){for(const r of e)await I(r,t)}(i,n))}exports.pack=function(e){R(e||"assets.json")};
